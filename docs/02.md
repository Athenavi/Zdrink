# 第三步：实现多租户架构和店铺管理基础模块

现在我们将实现多租户架构（SaaS模式）和店铺管理的基础模块，这是构建多门店系统的核心。

## 1. 安装额外依赖

更新 `backend/requirements.txt`，添加多租户支持：

```txt
# 在原有基础上添加
django-tenant-schemas
django-tenants
psycopg2-binary
```

安装新依赖：
```bash
pip install -r requirements.txt
```

## 2. 配置多租户架构

### 更新项目设置 `zdrink_core/settings.py`

## 3. 创建店铺模型（租户模型）

在 `apps/shops/models.py` 中定义店铺模型

## 4. 创建店铺序列化器

在 `apps/shops/serializers.py` 中定义店铺序列化器：


## 5. 创建店铺API视图

在 `apps/shops/api.py`中定义店铺API视图


## 6. 配置店铺URL路由

在 `apps/shops/urls.py`中定义店铺URL路由


## 7. 创建店铺管理后台

更新 `apps/shops/admin.py`中定义店铺管理后台


## 8. 更新项目URL配置

更新 `zdrink_core/urls.py` 以支持多租户架构

## 10. 创建超级用户和测试数据

```bash
# 创建超级用户
python manage.py createsuperuser

# 创建测试店铺（在Django shell中）
python manage.py shell
```

在Django shell中创建测试数据：
```python
from apps.shops.models import Shop, Domain

# 创建测试店铺
shop = Shop.objects.create(
    name="测试餐厅",
    description="这是一个测试餐厅",
    address="测试地址",
    phone="13800138000",
    shop_type="restaurant"
)

# 创建域名
Domain.objects.create(
    domain="test.localhost",  # 测试域名
    tenant=shop,
    is_primary=True
)

print(f"测试店铺创建成功: {shop.name}")
print(f"访问地址: http://test.localhost:8000/")
```

## 11. 测试多租户功能

启动开发服务器：
```bash
python manage.py runserver
```

测试API端点：

1. **创建店铺** (需要超级管理员权限):
   ```
   POST /api/shops/
   Authorization: Bearer <super_admin_token>
   {
     "name": "我的餐厅",
     "description": "美味的餐厅",
     "address": "餐厅地址",
     "phone": "13800138000",
     "email": "restaurant@example.com",
     "shop_type": "restaurant",
     "admin_email": "owner@example.com",
     "admin_password": "password123"
   }
   ```

2. **获取当前用户的店铺**:
   ```
   GET /api/shops/current/
   Authorization: Bearer <user_token>
   ```

3. **管理店铺员工**:
   ```
   POST /api/shops/1/staff/
   Authorization: Bearer <owner_token>
   {
     "email": "staff@example.com",
     "role": "staff",
     "permissions": {"order_manage": true}
   }
   ```

## 下一步计划

完成多租户架构和店铺管理后，下一步我们将：
1. 创建商品管理模块（包括多规格SKU）
2. 实现权限管理系统
3. 构建订单管理基础功能