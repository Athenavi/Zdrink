# 第五步：实现权限管理系统和订单管理基础功能

现在我们将实现完整的权限管理系统和订单管理的基础功能，包括购物车、订单流程等。

## 1. 创建权限管理模块

### 1.1 安装额外依赖

更新 `backend/requirements.txt`：

```txt
# 在原有基础上添加
django-guardian
django-role-permissions
```

安装新依赖：
```bash
pip install -r requirements.txt
```

### 1.2 创建权限模型和工具

在 `apps/core/permissions.py` 中创建权限模型

### 1.3 创建角色权限配置

在 `apps/core/roles.py` 中：

```python
# 角色权限配置
ROLE_PERMISSIONS = {
    'owner': {
        'name': '店主',
        'permissions': [
            'shop_manage',           # 店铺管理
            'staff_manage',          # 员工管理
            'product_manage',        # 商品管理
            'category_manage',       # 分类管理
            'order_manage',          # 订单管理
            'order_process',         # 订单处理
            'inventory_manage',      # 库存管理
            'payment_manage',        # 支付管理
            'customer_manage',       # 客户管理
            'report_view',           # 报表查看
            'setting_manage',        # 设置管理
        ]
    },
    'manager': {
        'name': '店长',
        'permissions': [
            'product_manage',        # 商品管理
            'category_manage',       # 分类管理
            'order_manage',          # 订单管理
            'order_process',         # 订单处理
            'inventory_manage',      # 库存管理
            'customer_manage',       # 客户管理
            'report_view',           # 报表查看
        ]
    },
    'staff': {
        'name': '员工',
        'permissions': [
            'order_process',         # 订单处理
            'inventory_manage',      # 库存管理（有限）
        ]
    },
    'cashier': {
        'name': '收银员',
        'permissions': [
            'order_process',         # 订单处理
        ]
    }
}

def get_role_permissions(role):
    """获取角色权限"""
    return ROLE_PERMISSIONS.get(role, {}).get('permissions', [])

def create_staff_permissions(role):
    """根据角色创建权限配置"""
    permissions = get_role_permissions(role)
    return {perm: True for perm in permissions}
```

## 2. 创建订单管理模块

### 2.1 创建订单模型

在 `apps/orders/models.py` 中创建订单模型

### 2.2 创建订单序列化器

在 `apps/orders/serializers.py` 中创建订单序列化器

### 2.3 创建订单API视图

在 `apps/orders/api.py` 中创建订单API视图

### 2.4 配置订单URL路由

在 `apps/orders/urls.py` 中配置订单URL路由

## 3. 更新设置和权限配置

### 3.1 更新项目设置

在 `zdrink_core/settings.py` 中添加：

```python
# 在INSTALLED_APPS中添加
INSTALLED_APPS = [
    # ... 其他应用
    'guardian',  # Django Guardian
]

# 认证后端
AUTHENTICATION_BACKENDS = (
    'django.contrib.auth.backends.ModelBackend',
    'guardian.backends.ObjectPermissionBackend',
)

# Guardian配置
ANONYMOUS_USER_NAME = None
GUARDIAN_GET_INIT_ANONYMOUS_USER = 'apps.users.models.get_anonymous_user_instance'
```

### 3.2 创建用户工具函数

在 `apps/users/models.py` 中添加：

```python
def get_anonymous_user_instance():
    """获取匿名用户实例（用于Guardian）"""
    from django.contrib.auth.models import AnonymousUser
    return AnonymousUser()
```

## 4. 创建数据库迁移

```bash
# 创建迁移文件
python manage.py makemigrations orders

# 执行迁移
python manage.py migrate_schemas
```

## 5. 创建订单管理后台

在 `apps/orders/admin.py` 中创建订单管理后台：

## 6. 测试订单和权限功能

启动开发服务器：
```bash
python manage.py runserver
```

测试API端点：

1. **添加到购物车**:
   ```
   POST /api/orders/carts/add_item/
   Authorization: Bearer <token>
   {
     "product_id": 1,
     "sku_id": 1,
     "quantity": 2,
     "attribute_option_ids": [1, 2]
   }
   ```

2. **创建订单**:
   ```
   POST /api/orders/orders/
   Authorization: Bearer <token>
   {
     "order_type": "takeaway",
     "customer_name": "张三",
     "customer_phone": "13800138000",
     "pickup_time": "2024-01-20T12:00:00Z",
     "cart_id": 1
   }
   ```

3. **更新订单状态**:
   ```
   POST /api/orders/orders/1/update_status/
   Authorization: Bearer <staff_token>
   {
     "status": "confirmed",
     "notes": "订单已确认"
   }
   ```

4. **获取订单统计**:
   ```
   GET /api/orders/orders/statistics/
   Authorization: Bearer <staff_token>
   ```

5. **获取订单仪表板**:
   ```
   GET /api/orders/dashboard/
   Authorization: Bearer <staff_token>
   ```

## 下一步计划

完成权限管理和订单系统后，下一步我们将：
1. 实现支付系统集成
2. 创建会员和积分系统
3. 实现优惠券和促销功能