# 第六步：实现支付系统、会员积分系统和优惠券系统

现在我们将实现支付系统集成、会员积分系统和优惠券促销功能。

## 1. 支付系统集成

### 1.1 安装支付相关依赖

更新 `backend/requirements.txt`：

```txt
# 在原有基础上添加
wechatpayv3
alipay-sdk-python
pycryptodome
qrcode
```

安装新依赖：
```bash
pip install -r requirements.txt
```

### 1.2 创建支付模型

在 `apps/payments/models.py` 中创建支付模型

### 1.3 创建支付服务类

创建 `apps/payments/services.py`中创建支付服务类

### 1.4 创建支付序列化器

在 `apps/payments/serializers.py` 中创建支付序列化器

### 1.5 创建支付API视图

更新 `apps/payments/api.py`

### 1.6 配置支付URL路由

更新 `apps/payments/urls.py`

## 2. 会员积分系统

### 2.1 扩展用户模型

更新 `apps/users/models.py`

### 2.2 创建会员积分服务

创建 `apps/users/services.py`

### 2.3 创建会员积分序列化器

在 `apps/users/serializers.py` 中添加

### 2.4 更新用户API视图

在 `apps/users/api.py`

### 2.5 更新用户URL路由

更新 `apps/users/urls.py`

## 3. 优惠券系统

### 3.1 创建优惠券模型

创建 `apps/promotions/models.py`

### 3.2 创建优惠券服务

创建 `apps/promotions/services.py`

### 3.3 创建优惠券序列化器

创建 `apps/promotions/serializers.py`

### 3.4 创建优惠券API视图

创建 `apps/promotions/api.py`

### 3.5 配置优惠券URL路由

创建 `apps/promotions/urls.py`

### 3.6 更新项目URL配置

在 `zdrink_core/urls.py` 中添加

## 4. 创建数据库迁移

```bash
# 创建迁移文件
python manage.py makemigrations payments users promotions

# 执行迁移
python manage.py migrate_schemas
```

## 5. 创建管理后台配置

### 5.1 支付管理后台

在 `apps/payments/admin.py` 中创建支付管理后台

## 6. 测试新功能

启动开发服务器并测试新功能：

1. **支付功能测试**:
   ```
   POST /api/payments/transactions/create_payment/
   {
     "order_id": 1,
     "payment_method_id": 1,
     "openid": "user_openid"  # 微信支付需要
   }
   ```

2. **会员积分测试**:
   ```
   GET /api/users/profile/membership/  # 获取会员信息
   POST /api/users/points/signin/      # 签到获得积分
   POST /api/users/recharges/recharge/ # 会员充值
   ```

3. **优惠券测试**:
   ```
   GET /api/promotions/available-coupons/    # 获取可领取优惠券
   POST /api/promotions/user-coupons/claim/  # 领取优惠券
   POST /api/promotions/apply-coupon/        # 应用优惠券
   ```

## 下一步计划

1. 实现云小票打印功能
2. 实现桌面扫码点餐和收银台功能